
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Ruby & Android  | Dacer Blog</title>

<meta name="author" content="Dacer"> 

<meta name="description" content="Advanced Events Removing event handlers 使用off(&lt;event name&gt;)可以取消监听 1
$(&#39;button&#39;).off(&#39;click&#39;); //可以取消所有对 $(&#39;button&#39;) &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Dacer Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="/javascripts/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Dacer Blog</a></h1>
<h4>Ruby & Android</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:blog.dacer.im">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/19/code-school-bi-ji-jquery-part2-level-5/">
		
			Code School笔记 - jQuery Part2 Level 5</a>
	</h2>
	<div class="entry-content">
		<h2>Advanced Events</h2>

<h3>Removing event handlers</h3>

<p>使用<code>off(&lt;event name&gt;)</code>可以取消监听</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">);</span> <span class="c1">//可以取消所有对 $(&#39;button&#39;) 的监听</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Namespacing Events</h3>

<p>可以给 event 取一个后缀的别名：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click.image&#39;</span><span class="p">,</span> <span class="nx">picture</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click.details&#39;</span><span class="p">,</span> <span class="nx">status</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;click.image&#39;</span><span class="p">);</span>  <span class="c1">//仅取消对第一个的监听</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;.image&#39;</span><span class="p">);</span>       <span class="c1">//取消所有后缀是.image的监听</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Triggering Events</h3>

<p>可以用来模拟用户行为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">);</span> <span class="c1">//相当于点击了 button</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Custom Event</h3>

<p>可以自定义一个 event 的名字，然后哦那个 trigger 调用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">dom</span> <span class="nx">element</span><span class="o">&gt;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;&lt;event&gt;.&lt;namespace&gt;&quot;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">method</span><span class="o">&gt;</span><span class="p">)</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.vacation&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;show.price&#39;</span><span class="p">,</span> <span class="nx">showPrice</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.vacation&#39;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;show.price&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.vacation:last&#39;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;show.price&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-19T11:13:03+08:00" pubdate data-updated="true">Feb 19<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/jquery/'>jQuery</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/18/code-school-bi-ji-jquery-part2-level-3-and-4/">
		
			Code School笔记 - jQuery Part2 Level 3 & 4</a>
	</h2>
	<div class="entry-content">
		<h2>Ajax Forms</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>  <span class="c1">//阻止原按钮的行为</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>      <span class="c1">//这样保存form为变量可以减少 DOM queries</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;/book&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="nx">form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span> <span class="c1">//可以合并form中所有的 fields 作为data</span>
</span><span class='line'>    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">form</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#vacation&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>With Json</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">),{</span>   <span class="c1">//自动从html的form中获取要post的地址</span>
</span><span class='line'>    <span class="nx">type</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">),</span>   <span class="c1">//自动获取 发送方式</span>
</span><span class='line'>    <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>  <span class="c1">//让服务器返回 json 格式的数据</span>
</span><span class='line'>    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>                 <span class="c1">//使发出的数据格式为 json</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="nx">form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
</span><span class='line'>      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">form</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;&lt;/p&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">msg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;Destination: &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="s2">&quot;. &quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">msg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;Price: &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">totalPrice</span> <span class="o">+</span> <span class="s2">&quot;. &quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">msg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;Nights: &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">nights</span> <span class="o">+</span> <span class="s2">&quot;. &quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">msg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;Confirmation: &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">confirmation</span><span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#vacation&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">msg</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Utility Methods</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.class&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="c1">//可以找到某个 .. 中的 某个 ..</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.book-title:eq(&quot;</span><span class="o">+</span><span class="nx">index</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="c1">//可以找到 class中的第 index 项</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>each</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">city</span><span class="p">)</span> <span class="p">{...});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>getJSON</code>专为json而简化后的ajax</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">￼</span><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">&#39;/status&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>map</code>将一个 array 中每个数据处理之后整合出一个新的array</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">item</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">index</span><span class="o">&gt;</span><span class="p">){});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//example</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">myNumbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">newNumbers</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">myNumbers</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">){</span> <span class="k">return</span> <span class="nx">item</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">});</span>
</span><span class='line'><span class="c1">// myNumbers  -&gt; [1,2,3,4]</span>
</span><span class='line'><span class="c1">// newNumbers -&gt; [2,3,4,5]</span>
</span></code></pre></td></tr></table></div></figure>


<p>用map将json数据转化为html</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">listItem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;h3&gt;&#39;</span><span class="o">+</span><span class="nx">status</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s1">&#39;&lt;/h3&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">listItem</span><span class="p">);</span> <span class="c1">//用appendTo可以将 .. 插入到 listItem其中</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">+</span><span class="nx">status</span><span class="p">.</span><span class="nx">status</span><span class="o">+</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">listItem</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">listItem</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="c1">//结果：</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Dacer</span><span class="o">&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Blog</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/li&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>map返回的array可以直接放入html中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">statusElements</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(...);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.status-list&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">statusElements</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>each</code>返回的是原 array，而<code>map</code>返回的是 return 的值的 array</p>

<h3>Detach</h3>

<p>.detach() removes an element from the DOM, preserving all data and events.<br/>
This is useful to minimize DOM insertions with multiple html elements.<br/>
.detach() removes the list from the DOM, then it can be modified and reinserted into the status element.
我对此的理解是detach能将一个 element 移出 DOM ，然后对它进行任何操作都不会对网页造成影响，修改完这个 element 之后再将其放回 DOM 。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.status-list&#39;</span><span class="p">).</span><span class="nx">detach</span><span class="p">()</span>
</span><span class='line'>                 <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">statusElements</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;.status&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-18T11:13:03+08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/jquery/'>jQuery</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/18/code-school-bi-ji-zombie-outlaws-level-7/">
		
			Code School笔记 - Zombie Outlaws Level 7</a>
	</h2>
	<div class="entry-content">
		<h2>ActionController Live &amp; Turbolinks</h2>

<p>使用<code>ActionController::Live</code>可以让服务器和 client 保持</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#controllers/items_controller.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ItemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Live</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>默认的 WEBrick 会断开连接，所以要使用  Puma or Rainbows or other compatible servers</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;puma&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#controllers/items_controller.rb</span>
</span><span class='line'><span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;text/event-stream&quot;</span>
</span><span class='line'>  <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span> <span class="s2">&quot;Hello, browser!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c1">#write一定要在设置了 headers 之后</span>
</span><span class='line'>      <span class="nb">sleep</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>EventSource</h3>

<p>使用js的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="nx">initialize</span><span class="p">);</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="s1">&#39;/items/events&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">update</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">update</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#items&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>使用Redis</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># controllers/items_controller.rb</span>
</span><span class='line'><span class="k">def</span> <span class="nf">events</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;text/event-stream&quot;</span>
</span><span class='line'>  <span class="n">redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">redis</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;item.create&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">on</span><span class="o">|</span>
</span><span class='line'>    <span class="n">on</span><span class="o">.</span><span class="n">message</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="o">|</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;data: </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Turbolinks</h2>

<p>Rails 4 中默认使用 Turbolinks 通过 ajax 来加快点击 link 之后的跳转速度</p>

<p>Turbolinks 会自动判断载入的 css js 有无改动</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= stylesheet_link_tag &quot;application&quot;, media:</span>
</span><span class='line'><span class="sx">  &quot;all&quot;, &quot;data-turbolinks-track&quot; =</span><span class="o">&gt;</span> <span class="kp">true</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;%= javascript_include_tag &quot;application&quot;,</span>
</span><span class='line'><span class="sx">  &quot;data-turbolinks-track&quot; =&gt;</span> <span class="kp">true</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>启用方法</h3>

<p>以下在 Rails 4 中默认启用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#Gemfile</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;turbolinks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#assets/javascripts/application.js</span>
</span><span class='line'> <span class="sr">//</span><span class="o">=</span> <span class="nb">require</span> <span class="n">turbolinks</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Turbolinks Events</h3>

<p>用 js 监听时要注意使用<code>page:load</code>，来初始化监听，以免点击link后监听失效</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#owner_active&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checked</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="nx">initialize</span><span class="p">);</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;page:load&#39;</span><span class="p">,</span> <span class="nx">initialize</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者可以用一个 gem 自动实现上述代码，ready() will always fire after &ldquo;page:load&rdquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span><span class="nx">Gemfile</span>
</span><span class='line'><span class="nx">gem</span> <span class="s1">&#39;jquery-turbolinks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">assets</span><span class="o">/</span><span class="nx">javascripts</span><span class="o">/</span><span class="nx">application</span><span class="p">.</span><span class="nx">js</span>
</span><span class='line'> <span class="c1">//= require jquery</span>
</span><span class='line'> <span class="c1">//= require jquery.turbolinks  #order is important!</span>
</span><span class='line'> <span class="c1">//= require jquery_ujs</span>
</span><span class='line'> <span class="c1">//= require turbolinks</span>
</span></code></pre></td></tr></table></div></figure>


<p>￼
另一种监听方式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">checkAlert</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checked</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;#owner_active&#39;</span><span class="p">,</span> <span class="nx">checkAlert</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>监听<code>page:fetch</code>和<code>page:change</code> 可以用来显示loading</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;page:fetch&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#loading&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;page:change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#loading&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>取消 Turbolinks</h3>

<p>Turbolinks affect all internal links by default, but you may not want all links to use it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;%=</span> <span class="nx">link_to</span> <span class="s1">&#39;Requests&#39;</span><span class="p">,</span> <span class="nx">requests_path</span><span class="p">,</span> <span class="s2">&quot;data-no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kc">true</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If a parent has the attribute, all children will be opted-out of Turbolinks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;navigation&quot;</span> <span class="nx">data</span><span class="o">-</span><span class="nx">no</span><span class="o">-</span><span class="nx">turbolink</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;%=</span> <span class="nx">link_to</span> <span class="s1">&#39;Show&#39;</span><span class="p">,</span> <span class="err">@</span><span class="nx">request</span> <span class="o">%&gt;</span> <span class="o">|</span>
</span><span class='line'>  <span class="o">&lt;%=</span> <span class="nx">link_to</span> <span class="s1">&#39;Back&#39;</span><span class="p">,</span> <span class="nx">requests_path</span> <span class="o">%&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-18T11:10:57+08:00" pubdate data-updated="true">Feb 18<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/rails-4/'>Rails 4</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/17/code-school-bi-ji-jquery-part2-level-1-and-2/">
		
			Code School笔记 - jQuery Part2 Level 1 & 2</a>
	</h2>
	<div class="entry-content">
		<h3>Ajax Basics</h3>

<p>使用Ajax时需要在网站后加上<code>?dc=123</code>之类的参数时可以用<code>data</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;confirmation.html&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>   <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>     <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.ticket&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">slideDown</span><span class="p">();</span>
</span><span class='line'>   <span class="p">},</span>
</span><span class='line'>   <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="nx">dacer</span> <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="c1">//confirmation.html?author=dacer</span>
</span></code></pre></td></tr></table></div></figure>


<p>timeout</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;confirmation.html&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>   <span class="p">...,</span>
</span><span class='line'>   <span class="nx">timeout</span><span class="o">:</span> <span class="mi">3000</span> <span class="c1">//3000ms = 3 seconds</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>还有<code>beforeSend``complete</code>等</p>

<h3>Event Delegation</h3>

<p>当你用jquery监听点击事件时只会在网页加载完毕后执行监听，如果是用ajax创造出来的是无法监听到的，所以要用到<code>Event Delegation</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.confirmation .view-boarding-pass&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="p">...</span> <span class="p">});</span> <span class="c1">//无法监听到</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.confirmation&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;.view-boarding-pass&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="p">...</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上代码是监听<code>.confirmation</code>中的点击事件，每次<code>.confirmation</code>中有元素被点击了之后都会检查是否是<code>.view-boarding-pass</code></p>

<h3>Javascript Object</h3>

<p>用<code>var</code>可以声明一个 Object ，然后将其中的function提取出来使代码更整洁</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">confirmation</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.confirmation&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadConfirmation</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.confirmation&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;.view-boarding-pass&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">showBoardingPass</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">loadConfirmation</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;confirmation.html&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">showBoardingPass</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">confirmation</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Javascript Function</h3>

<p>用驼峰法命名一个js的function</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">Blog</span><span class="p">(</span><span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// init</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">(</span><span class="s1">&#39;Dacer&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>function中可以嵌套function</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">Blog</span><span class="p">(</span><span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">print</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">author</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">(</span><span class="s1">&#39;Dacer&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">blog</span><span class="p">.</span><span class="nx">print</span><span class="p">();</span> <span class="c1">//&quot;Dacer&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>用 Function 重构之前的代码</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">Confirmation</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span><span class="p">;</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">ticket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.ticket&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">confirmation</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">loadConfirmation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;confirmation.html&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">timeout</span><span class="o">:</span> <span class="mi">3000</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">context</span><span class="o">:</span> <span class="nx">confirmation</span><span class="p">,</span> <span class="c1">//因为ajax内部的this和外部的不同，所以用context把内部的this替换成外部的</span>
</span><span class='line'>      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">ticket</span> <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">response</span><span class="p">).</span><span class="nx">slideDown</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-17T20:10:57+08:00" pubdate data-updated="true">Feb 17<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/jquery/'>jQuery</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/17/code-school-bi-ji-zombie-outlaws-level-6/">
		
			Code School笔记 - Zombie Outlaws Level 6</a>
	</h2>
	<div class="entry-content">
		<h2>ETags,Dalli, &amp; Cache-Digests</h2>

<h3>ETags</h3>

<p>在client请求网页时Rail 4会生成ETags一并发送回去，且client在第二次请求时会将ETags返回回来，此时Rails会再次生成ETags并与之比对，如果相同则返回304让client直接读取缓存的内容。<br/>
换句话说就是ETags是用来判断一个page是否有改变。</p>

<h3>Setting Custom ETags</h3>

<p>可以自定义ETags，<code>fresh_when</code>就是将Etags与<code>@item</code>相关联，在<code>@item.cache_key</code>不变时返回的Etags也相同，和上一节一样返回304</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ItemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@item</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="err">￼</span>    <span class="n">fresh_when</span><span class="p">(</span><span class="vi">@item</span><span class="p">)</span> <span class="c1"># =&gt; headers[&#39;ETag&#39;] = Digest::MD5.hexdigest(@item.cache_key)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># @item.cache_key</span>
</span><span class='line'><span class="c1"># = &#39;item/2-2011224150000&#39;</span>
</span><span class='line'><span class="c1"># = &lt;model name&gt;/ &lt;id&gt;-&lt;updated_at&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Declarative Etags</h3>

<p>可以简化Etags的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ItemsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">etag</span> <span class="p">{</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">etag</span> <span class="p">{</span> <span class="n">current_user</span><span class="o">.</span><span class="n">age</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@item</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fresh_when</span><span class="p">(</span><span class="vi">@item</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>    <span class="vi">@item</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">fresh_when</span><span class="p">(</span><span class="vi">@item</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">most_recent</span>
</span><span class='line'>    <span class="vi">@item</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="err">￼</span>    <span class="n">fresh_when</span><span class="p">(</span><span class="vi">@item</span><span class="p">)</span>  <span class="c1"># =&gt; fresh_when([@item, current_user.id, current_user.age])</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Dalli &amp; Cache-Digests</h2>

<p>Dalli is a high performance pure Ruby client for accessing memcached servers.<br/>
启用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/environments/production.rb</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">cache_store</span> <span class="o">=</span> <span class="ss">:mem_cache_store</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Gemfile</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;dalli&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Cache Store API</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="n">value</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#config/environments/production.rb</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Fragment Caching</h3>

<p>在某个 Client 第一次获取 fragments 时 Rail 4同时将其放入了 Cache中，之后有同样的 Request 时 Rails 就会直接从 Cache 中读取。<br/>
使用方式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
</span><span class='line'> <span class="o">&lt;</span><span class="sx">%= render document.comments %&gt;</span>
</span><span class='line'><span class="sx">&lt;/ul&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx"># 变为</span>
</span><span class='line'>
</span><span class='line'><span class="sx">&lt;% cache comment do %&gt;</span>
</span><span class='line'><span class="sx"> &lt;li&gt;&lt;%=</span> <span class="n">comment</span> <span class="sx">%&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#app/models/comment.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:document</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>上述方法和 ETags 类似，就是通过生成，保存，读取，对比 cache_key 来判断是否从 cache 读取还是重新 render ，<br/>
但是这样会出现一个问题：如果上面代码中的 comment 没有改变，但是网页中<code>&lt;% cache comment do %&gt;</code>中的内容进行了改变，如增加了<code>&lt;%= comment.author %&gt;</code>，就会造成之前的Client仍被缓存在之前的版本中，所以需要一个 template version :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% cache </span><span class="o">[</span><span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">]</span> <span class="k">do</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;li&gt;</span><span class="o">&lt;</span><span class="sx">%= comment %&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="sx">&lt;% end %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">#变为</span>
</span><span class='line'>
</span><span class='line'><span class="sx">&lt;% cache [&#39;v2&#39;, comment] do %&gt;</span>
</span><span class='line'><span class="sx">  &lt;li&gt;&lt;%=</span> <span class="n">comment</span> <span class="sx">%&gt; - &lt;%= comment.author %&gt;</span><span class="o">&lt;</span><span class="sr">/li&gt;</span>
</span><span class='line'><span class="sr">&lt;% end %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是 Rails 4 中的 cache 会自动保存和对比本文件的 MD5 Hash ，当这个改变时会同样重新缓存<br/>
<strong>所以 Rails 4 无需 version</strong></p>

<h3>Cache 嵌套出现的问题</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'># app/views/projects/show.html.erb
</span><span class='line'><span class="err">&lt;</span>%= render @project.documents %&gt;
</span><span class='line'>
</span><span class='line'># app/views/documents/_document.html.erb
</span><span class='line'><span class="err">&lt;</span>% cache document do %&gt;
</span><span class='line'> <span class="nt">&lt;article&gt;</span>
</span><span class='line'>   <span class="nt">&lt;h3&gt;</span><span class="err">&lt;</span>%= document.title %&gt;<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>   <span class="nt">&lt;ul&gt;</span>
</span><span class='line'>     <span class="err">&lt;</span>%= render document.comments %&gt;
</span><span class='line'>   <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>   <span class="err">&lt;</span>%= link_to &#39;View details&#39;, document %&gt;
</span><span class='line'> <span class="nt">&lt;/article&gt;</span>
</span><span class='line'> <span class="err">&lt;</span>% end %&gt;
</span><span class='line'>
</span><span class='line'># app/views/comments/_comment.html.erb
</span><span class='line'><span class="err">&lt;</span>% cache comment do %&gt;
</span><span class='line'>   <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= comment %&gt;<span class="nt">&lt;/li&gt;</span>
</span><span class='line'><span class="err">&lt;</span>% end %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>现在模拟下述流程：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>First Request to get Document 1:
</span><span class='line'>  document/1     sets cache
</span><span class='line'>    comment/1    sets cache
</span><span class='line'>    comment/2    sets cache
</span><span class='line'>
</span><span class='line'>Second Request to get Document 1:
</span><span class='line'>  document/1     reads cache
</span><span class='line'>
</span><span class='line'>Comment 2 gets Updated in Database
</span><span class='line'>
</span><span class='line'>Third Request to get Document 1:
</span><span class='line'>  document/1     reads cache
</span></code></pre></td></tr></table></div></figure>


<p>这样会发现被修改的<code>Comment 2</code>因为在<code>document</code>之内，所以无论怎么修改都仍会显示<code>document</code>的 cache，解决方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/models/comment.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:document</span><span class="p">,</span> <span class="ss">touch</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:dacer</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
增加了<code>touch: true</code>之后comment在更新了<code>updated_at</code>时会将所<code>belongs_to</code>的document的<code>updated_at</code>也一同更新了</p>

<h3>Cache Digests</h3>

<p>当使用<code>helper methods</code>时必须要用<code>partial</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="err">&lt;</span>% cache document do %&gt;
</span><span class='line'> <span class="nt">&lt;article&gt;</span>
</span><span class='line'>   <span class="nt">&lt;h3&gt;</span><span class="err">&lt;</span>%= document.title %&gt;<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>   <span class="nt">&lt;ul&gt;</span>
</span><span class='line'>   <span class="err">&lt;</span>%= render document.recent_comments %&gt; #需要替换为下面这个
</span><span class='line'>   <span class="err">&lt;</span>%= render partial: &quot;comments/comment&quot;,
</span><span class='line'>       collection: document.recent_comments %&gt;
</span><span class='line'>   <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>   <span class="err">&lt;</span>%= link_to &#39;More details&#39;, document %&gt;
</span><span class='line'> <span class="nt">&lt;/article&gt;</span>
</span><span class='line'> <span class="err">&lt;</span>% end %&gt;
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-17T11:10:57+08:00" pubdate data-updated="true">Feb 17<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/rails-4/'>Rails 4</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/zeng-jia-liao-duo-shuo-de-ping-lun-xi-tong/">
		
			增加了多说的评论系统</a>
	</h2>
	<div class="entry-content">
		<p>参考了</p>

<blockquote><p><a href="http://havee.me/internet/2013-02/add-duoshuo-commemt-system-into-octopress.html">http://havee.me/internet/2013-02/add-duoshuo-commemt-system-into-octopress.html</a></p></blockquote>

<p>顺便用css精简了下</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T18:17:00+08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/octopress/'>Octopress</a>, <a class='category' href='/blog/categories/duo-shuo/'>多说</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/jian-hua-octopressfa-bu-bu-zou/">
		
			简化Octopress发布步骤</a>
	</h2>
	<div class="entry-content">
		<p>用了一段时间 Octopress 确实挺好用的，就是发布需要两个步骤</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec rake generate
</span><span class='line'>bundle exec rake deploy  </span></code></pre></td></tr></table></div></figure>


<p>灰常麻烦，下面说说怎么简化：<br/>
首先<code>bundle exec</code>前缀是因为Gemfile中rake版本号被限定在旧的版本号了，把那行简化为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#Gemfile</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;rake&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后再</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">bundle</span> <span class="n">update</span>
</span></code></pre></td></tr></table></div></figure>


<p>就行了，<br/>
下一步是合并生成和发布，打开<code>Rakefile</code>,随便找个地方copy</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s2">&quot;Generate + Deploy&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:d</span> <span class="k">do</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="ss">:generate</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="ss">:deploy</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后以后要发布的时候用<code>rake d</code>就行了，灰常舒服<br/>
顺便也可以把preview简化一下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s2">&quot;Preview&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:p</span> <span class="k">do</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="ss">:preview</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后用<code>rake p</code>即可</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T17:43:24+08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/octopress/'>Octopress</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/15/code-school-bi-ji-zombie-outlaws-level-5/">
		
			Code School笔记 - Zombie Outlaws Level 5</a>
	</h2>
	<div class="entry-content">
		<h2>Test Your Mettle</h2>

<h3>Rake Tasks</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake test:models
</span><span class='line'>rake test:controllers
</span><span class='line'>rake test:helpers
</span><span class='line'>rake test:mailers</span></code></pre></td></tr></table></div></figure>


<h1>需回顾：</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ruby -Itest test/models/location_test.rb  #raises pending migration error</span></code></pre></td></tr></table></div></figure>


<h3>Re-Adding Performance Testing</h3>

<p>在 Rails 4 中需要添加 gem 实现</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'rails-perftest'
</span><span class='line'>gem 'ruby-prof'</span></code></pre></td></tr></table></div></figure>


<h3>Skip</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ItemTest</span> <span class="o">&lt;</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:TestCase</span>
</span><span class='line'>  <span class="nb">test</span> <span class="s2">&quot;can shorten its name&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">item</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Super-duper long name&quot;</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;Super-duper&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">short_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">test</span> <span class="s2">&quot;Made By Dacer&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">skip</span> <span class="c1">#Use &quot;skip&quot; method if you don&#39;t want to run a test right now</span>
</span><span class='line'>    <span class="n">blog</span> <span class="o">=</span> <span class="no">Blog</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">blog</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="s2">&quot;Dacer&quot;</span>
</span><span class='line'>    <span class="n">blog</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://blog.dacer.im&quot;</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="s2">&quot;dacer&quot;</span><span class="p">,</span> <span class="n">blog</span><span class="o">.</span><span class="n">short_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Minitest Test_Opts</h3>

<p>get passed as test parameters
Verbose mode shows run time and skip status for each test</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rake</span> <span class="nb">test</span><span class="ss">:models</span> <span class="no">TEST_OPTS</span><span class="o">=</span><span class="s2">&quot;--verbose&quot;</span>
</span><span class='line'><span class="no">Run</span> <span class="ss">options</span><span class="p">:</span> <span class="o">--</span><span class="n">verbose</span> <span class="o">--</span><span class="n">seed</span> <span class="mi">57945</span>
</span><span class='line'><span class="c1"># Running tests:</span>
</span><span class='line'><span class="no">ItemTest</span><span class="c1">#test_can_shorten_its_name = 0.07 s = .</span>
</span><span class='line'><span class="no">ItemTest</span><span class="c1">#test_doesn&#39;t_shorten_short_names = 0.00 s = S</span>
</span><span class='line'><span class="no">Finished</span> <span class="n">tests</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">076</span><span class="mi">938</span><span class="n">s</span><span class="p">,</span> <span class="mi">25</span><span class="o">.</span><span class="mi">9950</span> <span class="n">tests</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">9975</span>
</span><span class='line'><span class="n">assertions</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
</span><span class='line'><span class="mi">2</span> <span class="n">tests</span><span class="p">,</span> <span class="mi">1</span> <span class="n">assertions</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span><span class="p">,</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">,</span> <span class="mi">1</span> <span class="n">skips</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-15T19:10:57+08:00" pubdate data-updated="true">Feb 15<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/rails-4/'>Rails 4</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/15/code-school-bi-ji-zombie-outlaws-level-4/">
		
			Code School笔记 - Zombie Outlaws Level 4</a>
	</h2>
	<div class="entry-content">
		<h2>Views &amp; Vistas</h2>

<h3>Collection Form Helpers</h3>

<p>Rail 4 提供了更多的helpers</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Owner</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>   <span class="n">has_many</span> <span class="ss">:items</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'> <span class="k">class</span> <span class="nc">Item</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>   <span class="n">belongs_to</span> <span class="ss">:owner</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">collection_select</span><span class="p">(</span><span class="ss">:item</span><span class="p">,</span> <span class="ss">:owner_id</span><span class="p">,</span> <span class="no">Owner</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
</span><span class='line'><span class="n">collection_radio_buttons</span><span class="p">(</span><span class="ss">:item</span><span class="p">,</span> <span class="ss">:owner_id</span><span class="p">,</span> <span class="no">Owner</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
</span><span class='line'><span class="n">collection_check_boxes</span><span class="p">(</span><span class="ss">:item</span><span class="p">,</span> <span class="ss">:owner_id</span><span class="p">,</span> <span class="no">Owner</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Date Field</h3>

<p>Rails 4 提供了新的 <code>date_field</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">date_field</span> <span class="ss">:return_date</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Response Type From Controller</h3>

<p>默认返回json的格式</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>   <span class="vi">@owners</span> <span class="o">=</span> <span class="no">Owner</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>   <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>     <span class="nb">format</span><span class="o">.</span><span class="n">html</span>
</span><span class='line'>     <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@owners</span> <span class="p">}</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>自定义json返回的格式可以用<code>jbuilder</code>或者Rails 4 中新的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#views/owners/index.json.ruby</span>
</span><span class='line'><span class="n">owners_hashes</span> <span class="o">=</span> <span class="vi">@owners</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">owner</span><span class="o">|</span>
</span><span class='line'>   <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="n">owner</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">url</span><span class="p">:</span> <span class="n">owner_url</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">owners_hashes</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Output</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="ss">:&quot;Slow-draw&quot;</span><span class="p">,</span>  <span class="s2">&quot;url&quot;</span><span class="ss">:&quot;http://localhost:3000/owners/1&quot;</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="ss">:&quot;Dacer&quot;</span><span class="p">,</span>    <span class="s2">&quot;url&quot;</span><span class="ss">:&quot;http://blog.dacer.im/&quot;</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="ss">:&quot;Walking Ned&quot;</span><span class="p">,</span><span class="s2">&quot;url&quot;</span><span class="ss">:&quot;http://localhost:3000/owners/3&quot;</span><span class="p">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-15T19:10:57+08:00" pubdate data-updated="true">Feb 15<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/rails-4/'>Rails 4</a>

</div>


</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/15/code-school-bi-ji-zombie-outlaws-level-3/">
		
			Code School笔记 - Zombie Outlaws Level 3</a>
	</h2>
	<div class="entry-content">
		<h2>Strong Parameters and Remote Forms &amp; Filters, Session, Custom Flash Types</h2>

<h3>Strong Parameters</h3>

<p>在rails 4的controller中必须指定可接受的params</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">user_params</span>
</span><span class='line'>  <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中<code>rquire</code>会检查是否有参数中的key，没有则返回400错误，但并不会将这个key的值返回到<code>user_params</code>中，<code>permit</code>则会将参数中key对应的值返回<br/>
add this line if you want to raise errors for unpermitted params:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#config/application.rb</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">action_on_unpermitted_parameters</span> <span class="o">=</span> <span class="ss">:raise</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Authenticity Token</h3>

<p>Rails 会自动在form中的value加入token来防止机器人的spam</p>

<h3>Action Controller Filters/Actions</h3>

<p>3中的<code>before_filter</code>变为了<code>before_action</code>,可以让Controller在部分方法call之前做出一些动作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PeopleController</span> <span class="o">&lt;</span> <span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:set_person</span><span class="p">,</span>      <span class="ss">except</span><span class="p">:</span> <span class="o">[</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span> <span class="o">]</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:ensure_permission</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span> <span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Flash Types</h3>

<p>以下方法可以生成flash信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="vi">@item</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>  <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Item created.&#39;</span>
</span><span class='line'>  <span class="n">redirect_to</span> <span class="vi">@item</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;notice&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= flash[:notice] %&gt;<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;p&gt;</span> <span class="nt">&lt;strong&gt;</span>Name:<span class="nt">&lt;/strong&gt;</span> <span class="err">&lt;</span>%= @item.name %&gt;
</span><span class='line'><span class="nt">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中erb部分可以简写为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;notice&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= notice %&gt;<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;alert&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= alert %&gt;<span class="nt">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>你也可以自定义flash类型</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">add_flash_types</span> <span class="ss">:grunt</span><span class="p">,</span> <span class="ss">:snarl</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#...</span>
</span><span class='line'><span class="n">flash</span><span class="o">[</span><span class="ss">:grunt</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;braaains...&#39;</span>
</span><span class='line'><span class="c1">#或者简写为</span>
</span><span class='line'><span class="n">redirect_to</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">grunt</span><span class="p">:</span> <span class="s1">&#39;I&#39;</span><span class="n">m</span> <span class="no">Dacer</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;grunt&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= grunt %&gt;<span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-15T19:10:57+08:00" pubdate data-updated="true">Feb 15<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/code-school/'>Code School</a>, <a class='category' href='/blog/categories/rails-4/'>Rails 4</a>

</div>


</div></article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Dacer

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
